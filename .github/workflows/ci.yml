name: CI

on:
  push:
  pull_request:

jobs:
  test-and-sonar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn pytest httpx pytest-cov tinydb pydantic

      # Roda testes de todos os microserviços e gera coverage.xml na raiz
      - name: Rodar testes e gerar cobertura
        run: |
          echo "==> Rodando pytest com cobertura..."
          pytest -q \
            --cov=servico-equipamento \
            --cov=servico-externo \
            --cov=servico-aluguel \
            --cov-report=xml:coverage.xml \
            --cov-config=.coveragerc || true

          echo "==> Listando coverage.xml gerados:"
          find . -name "coverage.xml" -print || echo "Nenhum coverage.xml encontrado"

      # Ajusta o coverage.xml apenas se ele existir na raiz
      - name: Ajustar caminhos do coverage.xml
        run: |
          if [ ! -f coverage.xml ]; then
            echo "coverage.xml NÃO encontrado na raiz do repositório."
            echo "Provavelmente o pytest falhou antes de gerar o relatório OU gerou em outro caminho."
            echo "Pulando ajuste de caminhos. O SonarCloud vai rodar sem cobertura."
            exit 0
          fi

          echo "coverage.xml encontrado na raiz, ajustando caminhos..."

          python - << 'PY'
          import xml.etree.ElementTree as ET

          path = "coverage.xml"
          tree = ET.parse(path)
          root = tree.getroot()

          # Ajustar todas as <source> para apontar para a raiz do repositório
          for source in root.findall(".//sources/source"):
              source.text = "."

          tree.write(path, encoding="utf-8", xml_declaration=True)
          PY

          echo "Primeiras linhas do coverage.xml (ajustado):"
          head -40 coverage.xml || true

      - name: Setup Java (SonarCloud)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
