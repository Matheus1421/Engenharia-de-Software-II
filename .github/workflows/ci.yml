name: CI

on:
  push:
  pull_request:

jobs:
  test-and-sonar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn pytest httpx pytest-cov tinydb pydantic email-validator

      - name: Rodar testes e gerar cobertura (serviço a serviço)
        run: |
          set -e  # se der ruim em algo fora do pytest, falha o job

          # 1) servico-equipamento
          echo "==> Rodando testes do servico-equipamento"
          cd servico-equipamento
          pytest -q \
            --cov=. \
            --cov-report=xml:coverage.xml || true
          cd ..

          # 2) servico-aluguel
          echo "==> Rodando testes do servico-aluguel"
          cd servico-aluguel
          pytest -q \
            --cov=. \
            --cov-report=xml:coverage.xml || true
          cd ..

          # 3) servico-externo
          echo "==> Rodando testes do servico-externo"
          cd servico-externo
          pytest -q \
            --cov=. \
            --cov-report=xml:coverage.xml || true
          cd ..

          echo "==> coverage.xml gerados:"
          find . -name "coverage.xml" -print || echo "Nenhum coverage.xml encontrado"

      - name: Setup Java (SonarCloud)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
