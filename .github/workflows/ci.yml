name: CI

on:
  push:
  pull_request:

jobs:
  test-and-sonar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn pytest httpx pytest-cov tinydb pydantic

      - name: Rodar testes e gerar cobertura
        run: |
          pytest -q \
            --cov=servico-equipamento \
            --cov=servico-externo \
            --cov=servico-aluguel \
            --cov-report=xml:coverage.xml \
            --cov-config=.coveragerc || true

      - name: Ajustar caminhos do coverage.xml
        run: |
          if [ ! -f coverage.xml ]; then
            echo "coverage.xml não encontrado. Provavelmente os testes falharam antes de gerar o relatório."
            echo "Pulando ajuste de caminhos. O SonarCloud pode rodar sem cobertura."
            exit 0
          fi

          python - << 'PY'
          import xml.etree.ElementTree as ET

          path = "coverage.xml"
          tree = ET.parse(path)
          root = tree.getroot()

          for source in root.findall(".//sources/source"):
              source.text = "."

          tree.write(path, encoding="utf-8", xml_declaration=True)
          PY

          echo "coverage.xml (ajustado):"
          head -40 coverage.xml || true

      - name: Setup Java (SonarCloud)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
