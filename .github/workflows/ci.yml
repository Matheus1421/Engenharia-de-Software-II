name: CI

on:
  push:
  pull_request:

jobs:
  test-and-sonar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn pytest httpx pytest-cov tinydb pydantic email-validator respx python-dotenv pytest-asyncio pytest-mock

      - name: Rodar testes e gerar cobertura (serviço a serviço)
        run: |
          set -e  # se der ruim em algo fora do pytest, falha o job

          # 1) servico-equipamento
          echo "==> Rodando testes do servico-equipamento"
          cd servico-equipamento
          pytest tests/ -q \
            --cov=. \
            --cov-report=xml:coverage.xml \
            --cov-report=term
          cd ..

          # 2) servico-aluguel
          echo "==> Rodando testes do servico-aluguel"
          cd servico-aluguel
          pytest tests/ -q \
            --cov=. \
            --cov-report=xml:coverage.xml \
            --cov-report=term
          cd ..

          # 3) servico-externo
          echo "==> Rodando testes do servico-externo"
          cd servico-externo
          pytest tests/ -q \
            --cov=. \
            --cov-report=xml:coverage.xml \
            --cov-report=term
          cd ..

          echo "==> coverage.xml gerados:"
          find . -name "coverage.xml" -print || echo "Nenhum coverage.xml encontrado"

      - name: Ajustar <source> dos coverage.xml para caminhos relativos
        run: |
          python - << 'PY'
          import os
          import xml.etree.ElementTree as ET

          services = ["servico-equipamento", "servico-externo", "servico-aluguel"]

          for service in services:
              path = os.path.join(service, "coverage.xml")
              if not os.path.exists(path):
                  print(f"[WARN] {path} não encontrado, pulando.")
                  continue

              print(f"[INFO] Ajustando {path}...")
              tree = ET.parse(path)
              root = tree.getroot()

              # coverage.py: <coverage><sources><source>...</source></sources>...
              sources = root.find(".//sources")
              if sources is None:
                  sources = ET.SubElement(root, "sources")

              # limpar sources atuais
              for child in list(sources):
                  sources.remove(child)

              # adicionar uma única source relativa ao repo
              s = ET.SubElement(sources, "source")
              s.text = service  # ex: "servico-equipamento"

              tree.write(path, encoding="utf-8", xml_declaration=True)

          PY

          echo "==> Primeiras linhas dos coverage.xml ajustados:"
          head -40 servico-equipamento/coverage.xml || true
          head -40 servico-externo/coverage.xml || true
          head -40 servico-aluguel/coverage.xml || true

      - name: Setup Java (SonarCloud)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
