name: CI

on:
  push:
  pull_request:

jobs:
  test-and-sonar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn pytest httpx pytest-cov tinydb pydantic

      # roda testes e gera coverage.xml na raiz
      - name: Rodar testes e gerar cobertura
        run: |
          pytest -q \
            --cov=servico-equipamento \
            --cov-report=xml:coverage.xml \
            --cov-config=.coveragerc || true

      # ajusta só a tag <source> do coverage.xml
      - name: Ajustar caminhos do coverage.xml
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET

          path = "coverage.xml"
          tree = ET.parse(path)
          root = tree.getroot()

          # no modelo do coverage.py, as sources ficam em /coverage/sources/source
          for source in root.findall(".//sources/source"):
              # deixa tudo relativo à raiz do repo
              source.text = "./"

          # grava de volta
          tree.write(path, encoding="utf-8", xml_declaration=True)
          PY

          echo "coverage.xml depois do ajuste:"
          head -40 coverage.xml || true

      - name: Setup Java (SonarCloud)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
